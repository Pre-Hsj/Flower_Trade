<!DOCTYPE html>
{% load staticfiles %}
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>创客花店-商家后台管理</title>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/layer/3.5.1/layer.js"></script>
  <link rel="stylesheet" href={% static '/css/layui.css' %}>
  <script src={% static '/js/layui.js' %}></script>
</head>
<body>
<div class="layui-row" id="AddType" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form layui-from-pane" enctype="multipart/form-data" style="margin-top:20px" >
            <div class="layui-form-item">
                <label class="layui-form-label">种类名称</label>
                <div class="layui-input-block">
                    <input type="text" id="name" name="name"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">种类详情</label>
                <div class="layui-input-block">
                    <input type="text" id="detail" name="detail"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品简介" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn  layui-btn-submit " name="demo11" id="demo11" lay-submit="demo11" lay-filter="demo11">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="layui-row" id="AddGoods" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form layui-from-pane" enctype="multipart/form-data" style="margin-top:20px" >
               <!--************这里是上传图片的代码***************-->
                <!--************这里添加的隐藏的输入框，用来传递images的参数***************-->
                <input type="hidden" name="images" class="image123456" id="image123456">
                <div class="layui-form-item">
                    <label class="layui-form-label ">照片:</label>
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="test1">上传图片</button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" style="width: 100px;height: 100px;margin-left: 120px" id="demo1">
                            <p id="demoText"></p>
                        </div>
                    </div>
                </div>
                <!--************上面里是上传图片的代码***************-->

            <div class="layui-form-item">
                <label class="layui-form-label">商品类型</label>
                <div class="layui-input-block">
                    <select id="type" name="type" lay-filter="eqptType">
                        <option value="1">鲜切花</option>
                        <option value="2">仿真花</option>
                        <option value="3">永生花</option>
                        <option value="4">绿植</option>
                        <option value="5">干花</option>
                        <option value="6">花瓶</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品名称</label>
                <div class="layui-input-block">
                    <input type="text" id="name" name="name"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品简介</label>
                <div class="layui-input-block">
                    <input type="text" id="desc" name="desc"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品简介" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品价格</label>
                <div class="layui-input-block">
                    <input type="text" id="price" name="price"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品价格" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品单位</label>
                <div class="layui-input-block">
                    <input type="text" id="unite" name="unite"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品单位" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品库存量</label>
                <div class="layui-input-block">
                    <input type="text" id="stock" name="stock"  required  lay-verify="required" autocomplete="off" placeholder="请输入商品库存量" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品所属种类</label>
                <div class="layui-input-block">
                    <select id="goodstype" name="goodstype" lay-filter="eqptType">
                        {% for good in goods %}
                            <option value={{ good.id }}>{{ good.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品状态</label>
                <div class="layui-input-block">
                    <select id="status" name="status" lay-filter="eqptType">
                        <option value="0">下架</option>
                        <option value="1">上架</option>
                        <option value="2">待上架</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn  layui-btn-submit " name="demo111" id="demo111" lay-submit="demo111" lay-filter="demo111">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="layui-layout layui-layout-admin">
  <div class="layui-header layui-bg-cyan">
    <div class="layui-logo layui-hide-xs layui-bg-cyan" >创客花店<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>商家后台管理</div>
    <!-- 头部区域（可配合layui 已有的水平导航） -->
    <ul class="layui-nav layui-layout-left">
      <!-- 移动端显示 -->
      <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
        <i class="layui-icon layui-icon-spread-left"></i>
      </li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item layui-hide layui-show-md-inline-block">
        <a href="javascript:;">
          <img src={{business.image.url}} class="layui-nav-img">
            {{ business.name }}
        </a>
        <dl class="layui-nav-child">
          <dd><a href="javascript:void(0)"  onclick="updatePwd('修改密码',1)">修改密码</a></dd>
          <dd><a href={% url 'bussiness:login' %}>退出登录</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item" lay-header-event="menuRight" lay-unselect>
        <a href="javascript:;">
          <i class="layui-icon layui-icon-more-vertical"></i>
        </a>
      </li>
    </ul>
  </div>

  <div class="layui-side layui-bg-green">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree layui-bg-green " lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a class="" href="javascript:;">商家信息</a>
          <dl class="layui-nav-child">
            <dd><a href={% url 'bussiness:dian' business.id %} target="right" >店铺信息</a></dd>
            <dd><a href={% url 'bussiness:person' business.id %} target="right">联系人信息</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">商品信息</a>
          <dl class="layui-nav-child">
              <dd><a href={% url 'bussiness:types' business.id %} target="right">已创建的类别</a></dd>
              <dd><a href={% url 'bussiness:goods' business.id %} target="right">已发布的商品</a></dd>
              <dd><a href="#" onclick="addType()">创建新类别</a></dd>
              <dd><a href="#" onclick="addGoods()">发布新商品</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">订单管理</a>
          <dl class="layui-nav-child">
            <dd><a href={% url 'bussiness:order1' business.id 1%} target="right">订单查询</a></dd>
            <dd><a href="javascript:;" target="right">评价查询</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">数据查询</a>
          <dl class="layui-nav-child">
            <dd><a href={% url 'bussiness:datasearch0' business.id%} target="right">店铺数据查询</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">公告查询</a>
          <dl class="layui-nav-child">
            <dd><a href={% url 'public:notice' %} target="right">公告查询</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">消息反馈</a>
          <dl class="layui-nav-child">
            <dd><a href={% url 'public:history' business.id %} target="right">历史反馈</a></dd>
            <dd><a href={% url 'public:feedback' business.id %} target="right">消息反馈</a></dd>
          </dl>
        </li>
      </ul>
    </div>
  </div>
  
  <div class="layui-body">
    <!-- 内容主体区域 -->
    <div style="padding: 15px;">
      <iframe src={% url 'bussiness:dian' business.id %} name="right" frameborder="0" width="100%" height="1200"></iframe>
    </div>
  </div>
  
  <div class="layui-footer">
    <!-- 底部固定区域 -->
    CopyRight © 2022 华侨大学创客信息技术团队 All Rights Reserved
  </div>
</div>
<script>
//JS 
layui.use(['element', 'layer', 'util'], function(){
  var element = layui.element
  ,layer = layui.layer
  ,util = layui.util
  ,$ = layui.$;
  
  //头部事件
  util.event('lay-header-event', {
    //左侧菜单事件
    menuLeft: function(othis){
      layer.msg('展开左侧菜单的操作', {icon: 0});
    }
    ,menuRight: function(){
      layer.open({
        type: 1
        ,content: '<div style="padding: 15px;">处理右侧面板的操作</div>'
        ,area: ['260px', '100%']
        ,offset: 'rt' //右上角
        ,anim: 5
        ,shadeClose: true
      });
    }
  });
  
});
</script>
<script type="text/javascript" src={% static 'js/jquery-1.11.3.min.js' %}></script>
<script type="text/javascript" src={% static 'js/plugs.js' %}></script>
<script type="text/javascript">
  //添加编辑弹出层
  function addType() {
      layui.use('table', function(){
          var form = layui.form
          layer.open({
              type: 1,
              area: ['500px', '700px'],
              title: "创建新的商品类别",
              fixed: false,//不固定
              maxmin: true,
              shadeClose: false,
              content: $("#AddType")
          });
          form.on('submit(demo11)', function (massage) {
              //layer.alert(massage.field.name)
              //向服务器端发送修改指令
              $.ajaxSetup({
                  data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
              })
              $.ajax({
                  url: '/bussiness/addtypes/',
                  type:'post',
                  dataType:'json',
                  data:{
                      'id':{{ business.id }}, //哪个商家上传的，商家ID就是什么
                      'name':massage.field.name,
                      'detail':massage.field.detail,
                  },
                  success:function (suc) {
                      if(suc.code === 200){
                          //layer.closeAll('loading')
                          //layer.load(2);
                          layer.msg("创建成功",{icon: 6 });
                          //layer.closeAll()
                          location.reload();
                      }else{
                          layer.msg("创建失败！",{icon: 5})
                      }
                  },
                  cancel:function () {
                      layer.closeAll()
                  }
              })
              return false;
          })
  })
  }
  function addGoods() {
      layui.use('upload',function () {
            var upload = layui.upload;

            //普通图片上传
            var uploadInst = upload.render({
                elem: '#test1',
                url: '/bussiness/upload/',
                accept: 'images',

                size: 500000,
                data:{
                    csrfmiddlewaretoken:'{{ csrf_token }}',
                    'src': function () {
                        return $('#demo1').attr('src')
                    }
                },
                before:function (obj) {
                    obj.preview(function (index,file,result) {
                        $('#demo1').attr('src',result);
                    })
                }
                ,done:function (res) {
                    //如果上传失败
                    if(res.code > 0 ){
                        return layer.msg('上传失败');
                    }
                    //上传成功
                    var demoText = $('#demoText');
                    demoText.html('<span style="color: #4cae4c;">上传成功</span>');

                    var fileupload = $("#image123456");
                    fileupload.attr("value",res.data.src);
                    layer.msg("图片上传成功！点击确认修改按钮保存！")
                    console.log(fileupload.attr("value"));
                }
                ,error:function () {
                    //演示失败状态并实现重传
                    var demoText = $('#demoText');
                    demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                    demoText.find('.demo-reload').on('click', function(){
                        uploadInst.upload();
                    });
                }
            })
        })
      layui.use('table', function(){
          var form = layui.form
          layer.open({
              type: 1,
              area: ['500px', '700px'],
              title: "创建新的商品",
              fixed: false,//不固定
              maxmin: true,
              shadeClose: false,
              content: $("#AddGoods")
          });
          form.on('submit(demo111)', function (massage) {
              //layer.alert(massage.field.name)
              //向服务器端发送修改指令
              $.ajaxSetup({
                  data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
              })
              $.ajax({
                  url: '/bussiness/addgoods/',
                  type:'post',
                  dataType:'json',
                  data:{
                      'id':{{ business.id }}, //哪个商家上传的，商家ID就是什么
                      'name':massage.field.name,
                      'desc':massage.field.desc,
                      'price':massage.field.price,
                      'unite':massage.field.unite,
                      'stock':massage.field.stock,
                      'type':massage.field.type,
                      'status':massage.field.status,
                      'avator':massage.field.avator,
                      'image123456': $('#image123456').attr("value"),
                      'goodstype':massage.field.goodstype,

                  },
                  success:function (suc) {
                      if(suc.code === 200){
                          //layer.closeAll('loading')
                          //layer.load(2);
                          layer.msg("创建成功",{icon: 6 });
                          //layer.closeAll()
                          location.reload();
                      }else{
                          layer.msg("创建失败！",{icon: 5})
                      }
                  },
                  cancel:function () {
                      layer.closeAll()
                  }
              })
              return false;
          })
  })
  }
</script>
</body>
</html>